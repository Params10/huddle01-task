{"ast":null,"code":"\"use strict\";\n\nvar __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n\n    return extendStatics(d, b);\n  };\n\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n\n    function __() {\n      this.constructor = d;\n    }\n\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __spreadArray = this && this.__spreadArray || function (to, from) {\n  for (var i = 0, il = from.length, j = to.length; i < il; i++, j++) to[j] = from[i];\n\n  return to;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar events_1 = require(\"events\");\n\nvar hash_js_1 = __importDefault(require(\"hash.js\")); // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\n\n\nvar hdkey_1 = __importDefault(require(\"hdkey\"));\n\nvar sdk_1 = __importDefault(require(\"@cvbb/sdk\"));\n\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\n\nvar keyringType = 'Air Gaped Device';\nvar pathBase = 'm';\nvar MAX_INDEX = 1000;\n\nvar readKeyringDescription = function () {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var decodedResult, type, result, _a, xfp, xpub, path;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , sdk_1.default.read({\n            title: 'Sync Cobo Vault',\n            description: \"Please click 'Sync' in Cobo Vault and scan the QR code displayed later\"\n          })];\n\n        case 1:\n          decodedResult = _b.sent();\n          type = decodedResult.type, result = decodedResult.result;\n\n          if (type === 'json') {\n            _a = JSON.parse(result), xfp = _a.xfp, xpub = _a.xpub, path = _a.path;\n\n            if (xfp && xpub && path) {\n              return [2\n              /*return*/\n              , {\n                xfp: xfp,\n                xpub: xpub,\n                hdPath: path\n              }];\n            }\n          } else if (type === 'none') {\n            throw new Error('Reading canceled');\n          }\n\n          throw new Error('Invalid qrcode');\n      }\n    });\n  });\n};\n\nvar AirGapedKeyring = function (_super) {\n  __extends(AirGapedKeyring, _super);\n\n  function AirGapedKeyring(opts) {\n    var _this = _super.call(this) || this;\n\n    _this.xfp = '';\n    _this.xpub = '';\n    _this.hdPath = '';\n    _this.page = 0;\n    _this.perPage = 5;\n    _this.type = keyringType;\n    _this.accounts = [];\n    _this.currentAccount = 0;\n    _this.paths = {};\n    _this.latestAccount = 0;\n\n    _this.deserialize(opts);\n\n    return _this;\n  }\n\n  AirGapedKeyring.getKeyring = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, xpub, xfp, hdPath;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , readKeyringDescription()];\n\n          case 1:\n            _a = _b.sent(), xpub = _a.xpub, xfp = _a.xfp, hdPath = _a.hdPath;\n            return [2\n            /*return*/\n            , new AirGapedKeyring({\n              xfp: xfp,\n              xpub: xpub,\n              hdPath: hdPath,\n              perPage: 5,\n              page: 0,\n              accounts: [],\n              currentAccount: 0,\n              paths: {}\n            })];\n        }\n      });\n    });\n  };\n\n  AirGapedKeyring.getEmptyKeyring = function () {\n    return new AirGapedKeyring({\n      xfp: '',\n      xpub: '',\n      hdPath: '',\n      perPage: 5,\n      page: 0,\n      accounts: [],\n      currentAccount: 0,\n      paths: {}\n    });\n  };\n\n  AirGapedKeyring.prototype.readKeyring = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, xpub, xfp, hdPath;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , readKeyringDescription()];\n\n          case 1:\n            _a = _b.sent(), xpub = _a.xpub, xfp = _a.xfp, hdPath = _a.hdPath;\n            this.xfp = xfp;\n            this.xpub = xpub;\n            this.hdPath = hdPath;\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  AirGapedKeyring.prototype.checkKeyring = function () {\n    if (!this.xfp || !this.xpub || !this.hdPath) {\n      throw new Error('keyring not fulfilled, please call function `readKeyring` firstly');\n    }\n  };\n\n  AirGapedKeyring.prototype.serialize = function () {\n    return Promise.resolve({\n      xfp: this.xfp,\n      xpub: this.xpub,\n      hdPath: this.hdPath,\n      accounts: this.accounts,\n      currentAccount: this.currentAccount,\n      page: this.page,\n      perPage: this.perPage,\n      paths: this.paths\n    });\n  };\n\n  AirGapedKeyring.prototype.deserialize = function (opts) {\n    this.xfp = opts.xfp;\n    this.xpub = opts.xpub;\n    this.hdPath = opts.hdPath;\n    this.accounts = opts.accounts;\n    this.currentAccount = opts.currentAccount;\n    this.page = opts.page;\n    this.perPage = opts.perPage;\n    this.paths = opts.paths;\n  };\n\n  AirGapedKeyring.prototype.setCurrentAccount = function (index) {\n    this.currentAccount = index;\n  };\n\n  AirGapedKeyring.prototype.getCurrentAccount = function () {\n    return this.currentAccount;\n  };\n\n  AirGapedKeyring.prototype.getCurrentAddress = function () {\n    return this.accounts[this.currentAccount];\n  };\n\n  AirGapedKeyring.prototype.addAccounts = function (n) {\n    var _this = this;\n\n    if (n === void 0) {\n      n = 1;\n    }\n\n    return new Promise(function (resolve, reject) {\n      try {\n        var from = _this.latestAccount;\n        var to = from + n;\n        var newAccounts = [];\n\n        for (var i = from; i < to; i++) {\n          var address = _this._addressFromIndex(pathBase, i);\n\n          newAccounts.push(address);\n          _this.page = 0;\n          _this.latestAccount++;\n        }\n\n        _this.accounts = _this.accounts.concat(newAccounts);\n        resolve(_this.accounts);\n      } catch (e) {\n        reject(e);\n      }\n    });\n  };\n\n  AirGapedKeyring.prototype.getFirstPage = function () {\n    this.page = 0;\n    return this.__getPage(1);\n  };\n\n  AirGapedKeyring.prototype.getNextPage = function () {\n    return this.__getPage(1);\n  };\n\n  AirGapedKeyring.prototype.getPreviousPage = function () {\n    return this.__getPage(-1);\n  };\n\n  AirGapedKeyring.prototype.__getPage = function (increment) {\n    var _this = this;\n\n    this.page += increment;\n\n    if (this.page <= 0) {\n      this.page = 1;\n    }\n\n    return new Promise(function (resolve, reject) {\n      try {\n        var from = (_this.page - 1) * _this.perPage;\n        var to = from + _this.perPage;\n        var accounts = [];\n\n        for (var i = from; i < to; i++) {\n          var address = _this._addressFromIndex(pathBase, i);\n\n          accounts.push({\n            address: address,\n            balance: null,\n            index: i\n          });\n          _this.paths[ethereumjs_util_1.toChecksumAddress(address)] = i;\n        }\n\n        resolve(accounts);\n      } catch (e) {\n        reject(e);\n      }\n    });\n  };\n\n  AirGapedKeyring.prototype.getAccounts = function () {\n    return this.accounts;\n  };\n\n  AirGapedKeyring.prototype.removeAccount = function (address) {\n    if (!this.accounts.map(function (a) {\n      return a.toLowerCase();\n    }).includes(address.toLowerCase())) {\n      throw new Error(\"Address \" + address + \" not found in this keyring\");\n    }\n\n    this.accounts = this.accounts.filter(function (a) {\n      return a.toLowerCase() !== address.toLowerCase();\n    });\n  };\n\n  AirGapedKeyring.prototype.readSignature = function (signId) {\n    return __awaiter(this, void 0, void 0, function () {\n      var signature, _a, peerSignId, signatureHex, r, s, v;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , sdk_1.default.read({\n              title: 'Submit signing result',\n              description: 'Please scan signing result QR code displayed on your Cobo Vault'\n            })];\n\n          case 1:\n            signature = _b.sent();\n\n            if (signature) {\n              if (signature.type === 'ur') {\n                _a = JSON.parse(Buffer.from(signature.result, 'hex').toString('utf-8')), peerSignId = _a.signId, signatureHex = _a.signature;\n\n                if (peerSignId && signatureHex) {\n                  if (peerSignId !== signId) {\n                    throw new Error('read signature error: mismatched signId');\n                  }\n\n                  r = Buffer.from(signatureHex.slice(0, 64), 'hex');\n                  s = Buffer.from(signatureHex.slice(64, 128), 'hex');\n                  v = Buffer.from(signatureHex.slice(128), 'hex');\n                  return [2\n                  /*return*/\n                  , {\n                    r: r,\n                    s: s,\n                    v: v\n                  }];\n                }\n\n                throw new Error('invalid signature qrcode');\n              } else {\n                throw new Error('invalid signature qrcode');\n              }\n            }\n\n            throw new Error('read signature canceled');\n        }\n      });\n    });\n  }; // tx is an instance of the ethereumjs-transaction class.\n\n\n  AirGapedKeyring.serializeTx = function (tx) {\n    var items = __spreadArray(__spreadArray([], tx.raw.slice(0, 6)), [ethereumjs_util_1.toBuffer(tx.getChainId()), // TODO: stripping zeros should probably be a responsibility of the rlp module\n    ethereumjs_util_1.unpadBuffer(ethereumjs_util_1.toBuffer(0)), ethereumjs_util_1.unpadBuffer(ethereumjs_util_1.toBuffer(0))]);\n\n    return ethereumjs_util_1.rlp.encode(items);\n  };\n\n  AirGapedKeyring.prototype.signTransaction = function (address, tx) {\n    return __awaiter(this, void 0, void 0, function () {\n      var txHex, hdPath, signId, signPayload, _a, r, s, v;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            txHex = AirGapedKeyring.serializeTx(tx).toString('hex');\n            hdPath = this._pathFromAddress(address);\n            signId = hash_js_1.default.sha256().update(\"\" + txHex + hdPath + this.xfp).digest('hex').slice(0, 8);\n            signPayload = {\n              txHex: txHex,\n              xfp: this.xfp,\n              hdPath: hdPath,\n              signId: signId\n            };\n            return [4\n            /*yield*/\n            , sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n              hasNext: true,\n              title: 'Request signing transaction',\n              description: 'Please scan the QR code below with Cobo Vault, review transaction information and authorize to sign'\n            })];\n\n          case 1:\n            _b.sent();\n\n            return [4\n            /*yield*/\n            , this.readSignature(signId)];\n\n          case 2:\n            _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n            tx.r = r;\n            tx.s = s;\n            tx.v = v;\n            return [2\n            /*return*/\n            , tx];\n        }\n      });\n    });\n  };\n\n  AirGapedKeyring.prototype.signMessage = function (withAccount, data) {\n    return this.signPersonalMessage(withAccount, data);\n  };\n\n  AirGapedKeyring.prototype.signPersonalMessage = function (withAccount, messageHex) {\n    return __awaiter(this, void 0, void 0, function () {\n      var hdPath, signId, signPayload, _a, r, s, v;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            hdPath = this._pathFromAddress(withAccount);\n            signId = hash_js_1.default.sha256().update(\"\" + messageHex + hdPath + this.xfp).digest('hex').slice(0, 8);\n            signPayload = {\n              messageHex: messageHex,\n              xfp: this.xfp,\n              hdPath: hdPath,\n              signId: signId\n            };\n            return [4\n            /*yield*/\n            , sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n              hasNext: true,\n              title: 'Request signing message',\n              description: 'Please scan the QR code below with Cobo Vault, review message and authorize to sign'\n            })];\n\n          case 1:\n            _b.sent();\n\n            return [4\n            /*yield*/\n            , this.readSignature(signId)];\n\n          case 2:\n            _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n            return [2\n            /*return*/\n            , '0x' + r + s + v];\n        }\n      });\n    });\n  };\n\n  AirGapedKeyring.prototype.signTypedData = function (withAccount, typedData) {\n    return __awaiter(this, void 0, void 0, function () {\n      var hdPath, signId, signPayload, _a, r, s, v;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            hdPath = this._pathFromAddress(withAccount);\n            signId = hash_js_1.default.sha256().update(\"\" + JSON.stringify(typedData) + hdPath + this.xfp).digest('hex').slice(0, 8);\n            signPayload = {\n              data: typedData,\n              xfp: this.xfp,\n              hdPath: hdPath,\n              signId: signId\n            };\n            return [4\n            /*yield*/\n            , sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n              hasNext: true,\n              title: 'Request signing typed data',\n              description: 'Please scan the QR code below with Cobo Vault, review data and authorize to sign'\n            })];\n\n          case 1:\n            _b.sent();\n\n            return [4\n            /*yield*/\n            , this.readSignature(signId)];\n\n          case 2:\n            _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n            return [2\n            /*return*/\n            , Buffer.concat([r, s, v])];\n        }\n      });\n    });\n  };\n\n  AirGapedKeyring.prototype._addressFromIndex = function (pb, i) {\n    this.checkKeyring();\n\n    if (!this.hdk) {\n      this.hdk = hdkey_1.default.fromExtendedKey(this.xpub);\n    }\n\n    var dkey = this.hdk.derive(pb + \"/0/\" + i);\n    var address = '0x' + ethereumjs_util_1.publicToAddress(dkey.publicKey, true).toString('hex');\n    return ethereumjs_util_1.toChecksumAddress(address);\n  };\n\n  AirGapedKeyring.prototype._pathFromAddress = function (address) {\n    var checksummedAddress = ethereumjs_util_1.toChecksumAddress(address);\n    var index = this.paths[checksummedAddress];\n\n    if (typeof index === 'undefined') {\n      for (var i = 0; i < MAX_INDEX; i++) {\n        if (checksummedAddress === this._addressFromIndex(pathBase, i)) {\n          index = i;\n          break;\n        }\n      }\n    }\n\n    if (typeof index === 'undefined') {\n      throw new Error('Unknown address');\n    }\n\n    return this.hdPath + \"/0/\" + index;\n  };\n\n  AirGapedKeyring.type = keyringType;\n  return AirGapedKeyring;\n}(events_1.EventEmitter);\n\nexports.default = AirGapedKeyring;","map":{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        if (typeof b !== \"function\" && b !== null)\n            throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nvar __spreadArray = (this && this.__spreadArray) || function (to, from) {\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\n        to[j] = from[i];\n    return to;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar events_1 = require(\"events\");\nvar hash_js_1 = __importDefault(require(\"hash.js\"));\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nvar hdkey_1 = __importDefault(require(\"hdkey\"));\nvar sdk_1 = __importDefault(require(\"@cvbb/sdk\"));\nvar ethereumjs_util_1 = require(\"ethereumjs-util\");\nvar keyringType = 'Air Gaped Device';\nvar pathBase = 'm';\nvar MAX_INDEX = 1000;\nvar readKeyringDescription = function () { return __awaiter(void 0, void 0, void 0, function () {\n    var decodedResult, type, result, _a, xfp, xpub, path;\n    return __generator(this, function (_b) {\n        switch (_b.label) {\n            case 0: return [4 /*yield*/, sdk_1.default.read({\n                    title: 'Sync Cobo Vault',\n                    description: \"Please click 'Sync' in Cobo Vault and scan the QR code displayed later\",\n                })];\n            case 1:\n                decodedResult = _b.sent();\n                type = decodedResult.type, result = decodedResult.result;\n                if (type === 'json') {\n                    _a = JSON.parse(result), xfp = _a.xfp, xpub = _a.xpub, path = _a.path;\n                    if (xfp && xpub && path) {\n                        return [2 /*return*/, {\n                                xfp: xfp,\n                                xpub: xpub,\n                                hdPath: path,\n                            }];\n                    }\n                }\n                else if (type === 'none') {\n                    throw new Error('Reading canceled');\n                }\n                throw new Error('Invalid qrcode');\n        }\n    });\n}); };\nvar AirGapedKeyring = /** @class */ (function (_super) {\n    __extends(AirGapedKeyring, _super);\n    function AirGapedKeyring(opts) {\n        var _this = _super.call(this) || this;\n        _this.xfp = '';\n        _this.xpub = '';\n        _this.hdPath = '';\n        _this.page = 0;\n        _this.perPage = 5;\n        _this.type = keyringType;\n        _this.accounts = [];\n        _this.currentAccount = 0;\n        _this.paths = {};\n        _this.latestAccount = 0;\n        _this.deserialize(opts);\n        return _this;\n    }\n    AirGapedKeyring.getKeyring = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a, xpub, xfp, hdPath;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, readKeyringDescription()];\n                    case 1:\n                        _a = _b.sent(), xpub = _a.xpub, xfp = _a.xfp, hdPath = _a.hdPath;\n                        return [2 /*return*/, new AirGapedKeyring({\n                                xfp: xfp,\n                                xpub: xpub,\n                                hdPath: hdPath,\n                                perPage: 5,\n                                page: 0,\n                                accounts: [],\n                                currentAccount: 0,\n                                paths: {},\n                            })];\n                }\n            });\n        });\n    };\n    AirGapedKeyring.getEmptyKeyring = function () {\n        return new AirGapedKeyring({\n            xfp: '',\n            xpub: '',\n            hdPath: '',\n            perPage: 5,\n            page: 0,\n            accounts: [],\n            currentAccount: 0,\n            paths: {},\n        });\n    };\n    AirGapedKeyring.prototype.readKeyring = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a, xpub, xfp, hdPath;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, readKeyringDescription()];\n                    case 1:\n                        _a = _b.sent(), xpub = _a.xpub, xfp = _a.xfp, hdPath = _a.hdPath;\n                        this.xfp = xfp;\n                        this.xpub = xpub;\n                        this.hdPath = hdPath;\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    AirGapedKeyring.prototype.checkKeyring = function () {\n        if (!this.xfp || !this.xpub || !this.hdPath) {\n            throw new Error('keyring not fulfilled, please call function `readKeyring` firstly');\n        }\n    };\n    AirGapedKeyring.prototype.serialize = function () {\n        return Promise.resolve({\n            xfp: this.xfp,\n            xpub: this.xpub,\n            hdPath: this.hdPath,\n            accounts: this.accounts,\n            currentAccount: this.currentAccount,\n            page: this.page,\n            perPage: this.perPage,\n            paths: this.paths,\n        });\n    };\n    AirGapedKeyring.prototype.deserialize = function (opts) {\n        this.xfp = opts.xfp;\n        this.xpub = opts.xpub;\n        this.hdPath = opts.hdPath;\n        this.accounts = opts.accounts;\n        this.currentAccount = opts.currentAccount;\n        this.page = opts.page;\n        this.perPage = opts.perPage;\n        this.paths = opts.paths;\n    };\n    AirGapedKeyring.prototype.setCurrentAccount = function (index) {\n        this.currentAccount = index;\n    };\n    AirGapedKeyring.prototype.getCurrentAccount = function () {\n        return this.currentAccount;\n    };\n    AirGapedKeyring.prototype.getCurrentAddress = function () {\n        return this.accounts[this.currentAccount];\n    };\n    AirGapedKeyring.prototype.addAccounts = function (n) {\n        var _this = this;\n        if (n === void 0) { n = 1; }\n        return new Promise(function (resolve, reject) {\n            try {\n                var from = _this.latestAccount;\n                var to = from + n;\n                var newAccounts = [];\n                for (var i = from; i < to; i++) {\n                    var address = _this._addressFromIndex(pathBase, i);\n                    newAccounts.push(address);\n                    _this.page = 0;\n                    _this.latestAccount++;\n                }\n                _this.accounts = _this.accounts.concat(newAccounts);\n                resolve(_this.accounts);\n            }\n            catch (e) {\n                reject(e);\n            }\n        });\n    };\n    AirGapedKeyring.prototype.getFirstPage = function () {\n        this.page = 0;\n        return this.__getPage(1);\n    };\n    AirGapedKeyring.prototype.getNextPage = function () {\n        return this.__getPage(1);\n    };\n    AirGapedKeyring.prototype.getPreviousPage = function () {\n        return this.__getPage(-1);\n    };\n    AirGapedKeyring.prototype.__getPage = function (increment) {\n        var _this = this;\n        this.page += increment;\n        if (this.page <= 0) {\n            this.page = 1;\n        }\n        return new Promise(function (resolve, reject) {\n            try {\n                var from = (_this.page - 1) * _this.perPage;\n                var to = from + _this.perPage;\n                var accounts = [];\n                for (var i = from; i < to; i++) {\n                    var address = _this._addressFromIndex(pathBase, i);\n                    accounts.push({\n                        address: address,\n                        balance: null,\n                        index: i,\n                    });\n                    _this.paths[ethereumjs_util_1.toChecksumAddress(address)] = i;\n                }\n                resolve(accounts);\n            }\n            catch (e) {\n                reject(e);\n            }\n        });\n    };\n    AirGapedKeyring.prototype.getAccounts = function () {\n        return this.accounts;\n    };\n    AirGapedKeyring.prototype.removeAccount = function (address) {\n        if (!this.accounts.map(function (a) { return a.toLowerCase(); }).includes(address.toLowerCase())) {\n            throw new Error(\"Address \" + address + \" not found in this keyring\");\n        }\n        this.accounts = this.accounts.filter(function (a) { return a.toLowerCase() !== address.toLowerCase(); });\n    };\n    AirGapedKeyring.prototype.readSignature = function (signId) {\n        return __awaiter(this, void 0, void 0, function () {\n            var signature, _a, peerSignId, signatureHex, r, s, v;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0: return [4 /*yield*/, sdk_1.default.read({\n                            title: 'Submit signing result',\n                            description: 'Please scan signing result QR code displayed on your Cobo Vault',\n                        })];\n                    case 1:\n                        signature = _b.sent();\n                        if (signature) {\n                            if (signature.type === 'ur') {\n                                _a = JSON.parse(Buffer.from(signature.result, 'hex').toString('utf-8')), peerSignId = _a.signId, signatureHex = _a.signature;\n                                if (peerSignId && signatureHex) {\n                                    if (peerSignId !== signId) {\n                                        throw new Error('read signature error: mismatched signId');\n                                    }\n                                    r = Buffer.from(signatureHex.slice(0, 64), 'hex');\n                                    s = Buffer.from(signatureHex.slice(64, 128), 'hex');\n                                    v = Buffer.from(signatureHex.slice(128), 'hex');\n                                    return [2 /*return*/, {\n                                            r: r,\n                                            s: s,\n                                            v: v,\n                                        }];\n                                }\n                                throw new Error('invalid signature qrcode');\n                            }\n                            else {\n                                throw new Error('invalid signature qrcode');\n                            }\n                        }\n                        throw new Error('read signature canceled');\n                }\n            });\n        });\n    };\n    // tx is an instance of the ethereumjs-transaction class.\n    AirGapedKeyring.serializeTx = function (tx) {\n        var items = __spreadArray(__spreadArray([], tx.raw.slice(0, 6)), [\n            ethereumjs_util_1.toBuffer(tx.getChainId()),\n            // TODO: stripping zeros should probably be a responsibility of the rlp module\n            ethereumjs_util_1.unpadBuffer(ethereumjs_util_1.toBuffer(0)),\n            ethereumjs_util_1.unpadBuffer(ethereumjs_util_1.toBuffer(0)),\n        ]);\n        return ethereumjs_util_1.rlp.encode(items);\n    };\n    AirGapedKeyring.prototype.signTransaction = function (address, tx) {\n        return __awaiter(this, void 0, void 0, function () {\n            var txHex, hdPath, signId, signPayload, _a, r, s, v;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        txHex = AirGapedKeyring.serializeTx(tx).toString('hex');\n                        hdPath = this._pathFromAddress(address);\n                        signId = hash_js_1.default.sha256().update(\"\" + txHex + hdPath + this.xfp).digest('hex').slice(0, 8);\n                        signPayload = {\n                            txHex: txHex,\n                            xfp: this.xfp,\n                            hdPath: hdPath,\n                            signId: signId,\n                        };\n                        return [4 /*yield*/, sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n                                hasNext: true,\n                                title: 'Request signing transaction',\n                                description: 'Please scan the QR code below with Cobo Vault, review transaction information and authorize to sign',\n                            })];\n                    case 1:\n                        _b.sent();\n                        return [4 /*yield*/, this.readSignature(signId)];\n                    case 2:\n                        _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n                        tx.r = r;\n                        tx.s = s;\n                        tx.v = v;\n                        return [2 /*return*/, tx];\n                }\n            });\n        });\n    };\n    AirGapedKeyring.prototype.signMessage = function (withAccount, data) {\n        return this.signPersonalMessage(withAccount, data);\n    };\n    AirGapedKeyring.prototype.signPersonalMessage = function (withAccount, messageHex) {\n        return __awaiter(this, void 0, void 0, function () {\n            var hdPath, signId, signPayload, _a, r, s, v;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        hdPath = this._pathFromAddress(withAccount);\n                        signId = hash_js_1.default.sha256().update(\"\" + messageHex + hdPath + this.xfp).digest('hex').slice(0, 8);\n                        signPayload = {\n                            messageHex: messageHex,\n                            xfp: this.xfp,\n                            hdPath: hdPath,\n                            signId: signId,\n                        };\n                        return [4 /*yield*/, sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n                                hasNext: true,\n                                title: 'Request signing message',\n                                description: 'Please scan the QR code below with Cobo Vault, review message and authorize to sign',\n                            })];\n                    case 1:\n                        _b.sent();\n                        return [4 /*yield*/, this.readSignature(signId)];\n                    case 2:\n                        _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n                        return [2 /*return*/, '0x' + r + s + v];\n                }\n            });\n        });\n    };\n    AirGapedKeyring.prototype.signTypedData = function (withAccount, typedData) {\n        return __awaiter(this, void 0, void 0, function () {\n            var hdPath, signId, signPayload, _a, r, s, v;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        hdPath = this._pathFromAddress(withAccount);\n                        signId = hash_js_1.default\n                            .sha256()\n                            .update(\"\" + JSON.stringify(typedData) + hdPath + this.xfp)\n                            .digest('hex')\n                            .slice(0, 8);\n                        signPayload = {\n                            data: typedData,\n                            xfp: this.xfp,\n                            hdPath: hdPath,\n                            signId: signId,\n                        };\n                        return [4 /*yield*/, sdk_1.default.play(Buffer.from(JSON.stringify(signPayload), 'utf-8').toString('hex'), {\n                                hasNext: true,\n                                title: 'Request signing typed data',\n                                description: 'Please scan the QR code below with Cobo Vault, review data and authorize to sign',\n                            })];\n                    case 1:\n                        _b.sent();\n                        return [4 /*yield*/, this.readSignature(signId)];\n                    case 2:\n                        _a = _b.sent(), r = _a.r, s = _a.s, v = _a.v;\n                        return [2 /*return*/, Buffer.concat([r, s, v])];\n                }\n            });\n        });\n    };\n    AirGapedKeyring.prototype._addressFromIndex = function (pb, i) {\n        this.checkKeyring();\n        if (!this.hdk) {\n            this.hdk = hdkey_1.default.fromExtendedKey(this.xpub);\n        }\n        var dkey = this.hdk.derive(pb + \"/0/\" + i);\n        var address = '0x' + ethereumjs_util_1.publicToAddress(dkey.publicKey, true).toString('hex');\n        return ethereumjs_util_1.toChecksumAddress(address);\n    };\n    AirGapedKeyring.prototype._pathFromAddress = function (address) {\n        var checksummedAddress = ethereumjs_util_1.toChecksumAddress(address);\n        var index = this.paths[checksummedAddress];\n        if (typeof index === 'undefined') {\n            for (var i = 0; i < MAX_INDEX; i++) {\n                if (checksummedAddress === this._addressFromIndex(pathBase, i)) {\n                    index = i;\n                    break;\n                }\n            }\n        }\n        if (typeof index === 'undefined') {\n            throw new Error('Unknown address');\n        }\n        return this.hdPath + \"/0/\" + index;\n    };\n    AirGapedKeyring.type = keyringType;\n    return AirGapedKeyring;\n}(events_1.EventEmitter));\nexports.default = AirGapedKeyring;\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}